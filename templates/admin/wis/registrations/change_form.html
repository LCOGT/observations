{% extends "admin/change_form.html" %}
{% load extra_options adminmedia %}

{% block extrahead %}

{{ block.super }}
<script type='text/javascript' src='{{ MEDIA_URL }}admin/js/jquery.js'></script>
    <script type='text/javascript'>
function hello(){
	alert("hello");
}
$(document).ready(function() {
   // Initially hide toggle link
   $(".toggle_button").hide(); 
	
   $('a.urilookup').click(function() {	
		var postcode = $(this).attr('pc');
		var edurl = "http://services.data.gov.uk/education/sparql";
		var sparql = "prefix geo: <http://www.w3.org/2003/01/geo/wgs84_pos#>		prefix sch-ont: <http://education.data.gov.uk/def/school/>		SELECT * WHERE {		 ?school a sch-ont:School;		    sch-ont:establishmentName ?name;		    geo:lat ?lat ;		    geo:long ?long.		 OPTIONAL {		  ?school sch-ont:address ?address .		  ?address sch-ont:postcode ?postcode.		  OPTIONAL {		   ?address sch-ont:town ?town .		  }		 }		 FILTER (?postcode = '"+postcode+"')		}		ORDER BY ?name";
		// Parsing the SPARQL through YQL until they can fix the format of their json
		var yql = "http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20sparql.search%20where%20query%3D%22prefix%20geo%3A%20%3Chttp%3A%2F%2Fwww.w3.org%2F2003%2F01%2Fgeo%2Fwgs84_pos%23%3E%09%09prefix%20sch-ont%3A%20%3Chttp%3A%2F%2Feducation.data.gov.uk%2Fdef%2Fschool%2F%3E%09%09SELECT%20*%20WHERE%20%7B%09%09%20%3Fschool%20a%20sch-ont%3ASchool%3B%09%09%20%20%20%20sch-ont%3AestablishmentName%20%3Fname%3B%09%09%20%20%20%20geo%3Alat%20%3Flat%20%3B%09%09%20%20%20%20geo%3Along%20%3Flong.%09%09%20OPTIONAL%20%7B%09%09%20%20%3Fschool%20sch-ont%3Aaddress%20%3Faddress%20.%09%09%20%20%3Faddress%20sch-ont%3Apostcode%20%3Fpostcode.%09%09%20%20OPTIONAL%20%7B%09%09%20%20%20%3Faddress%20sch-ont%3Atown%20%3Ftown%20.%09%09%20%20%7D%09%09%20%7D%09%09%20FILTER%20(%3Fpostcode%20%3D%20'"+postcode+"')%09%09%7D%09%09ORDER%20BY%20%3Fschool%22%20and%20service%3D%22http%3A%2F%2Fservices.data.gov.uk%2Feducation%2Fsparql%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=?";

		// Bug fix for reading local JSON file in FF3
		$.ajaxSetup({async:false,'beforeSend': function(xhr){ if (xhr.overrideMimeType) xhr.overrideMimeType("text/plain"); } });

		$('#schooluri').append('<div id="progress"><img src="{{ MEDIA_URL }}admin/img/ajax-loader.gif"></div>');
		//$.getJSON(edurl, {query : sparql, output:"json"},
		$.getJSON(yql,
		 	function(data){
			  if (typeof data.query.results.sparql.result != "undefined"){
				  if (data.query.results.sparql.result.length > 1){
					  $.each(data.query.results.sparql.result,function(i,item){
						  str = item.school.value
						  str = str.substring(str.lastIndexOf("\/")+1)
						  var line = "<a href='#' urn='"+item.school.value+"' class='loadurn'>"+item.name.value+"</a> (<a href='"+item.school.value+"' target='_blank'>"+str+"</a>)<br/>";
					 	  $('#schooluri').append(line);	
					 });
				  }else{
					item = data.query.results.sparql.result;
					str = item.school.value
					str = str.substring(str.lastIndexOf("\/")+1)
					var line = "<a href='#' urn='"+item.school.value+"' class='loadurn'>"+item.name.value+"</a> (<a href='"+item.school.value+"' target='_blank'>"+str+"</a>)<br/>";
					$('#schooluri').append(line);
				  }
				}else{
				 var line = "No results found. Check user is a UK school and postcode is correct.";
				 $('#schooluri').append(line);
			  }
			  $('#progress').remove();
		      $('a.loadurn').click(function() {
				var urn = $(this).attr('urn');
				$('input:text[name=schooluri_set-0-uri]').val(urn);
			 });
		 	}
		);
		//$('#progress').remove();
		
	})
	
	
   $('a.updatecredit').click(function () {
	 	var mins = $("input:text[name=peakmins]").val();
	    var reason = $("input:text[name=reason]").val();
	 	var oldmins = $("span#mins").text();
	 	var newmins = parseInt(mins) + parseInt(oldmins);
	 	var reg = $("#regid").attr('regid');
	    $.post("{% url rtiadminsite.wis.views.addcredit %}", {schoolid: reg ,peakmins: mins,reason:reason}, function(data){
	        $("#hist").prepend(data);
	  });
	   $("span#mins ").text(newmins);
  })
  
  $('a.bookedslots').click(function(){
     var reg = $("#regid").attr('regid');
       $.post("{% url rtiadminsite.wis.views.slots_by_user %}", {userid: reg}, function(data){
	        $("#bookings").html(data);
	  });
	  $(".toggle_button").show();
  })
  $('.toggle_button').click(function() {
       $("#bookings").slideToggle('normal');
    });

});

 </script>
{% endblock %}

{% block coltype %}regCol{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block object-tools %}
<div id="regid" regid="{{object_id}}"></div>
{% endblock %}

{% block content_title %}<h1>User ID: {{ object_id }}</h1>{% endblock %}

{% block sidebar %}
{% if object_id %}
{% credit_info object_id %}
{% endif %}
{% endblock %}